<!-- <keep-alive> -->
<template>
  <div class="snList">
    <div class="h25"></div>
    <div @click="errorBoxHide" v-show="errorShow">
      <ScanError></ScanError>
    </div>
    <div @click="putIn" v-show="putInShow">
      <PutIn>
        <p>{{alertMsg}}</p>
      </PutIn>
    </div>
    <div class="snDetail">
      <SNDetail></SNDetail>
    </div>
    <div class="headBox">
      <HeadComponent :settingShow="true">
        <h1>{{moduleName}}</h1>
        <button v-show="canDel" @click="checkBoxShowFn(showCheckbox)" class="delBtn"></button>
      </HeadComponent>
      <ul class="snBox clearfix">
        <li>
          <input :value="'单号：' + opNum" disabled="disabled">
        </li>
        <li v-show="canDel">
          <input type="text" v-model="inputVal" placeholder="条码" v-focus="focusStatus" @keyup.enter="enterKey">
          <button @click="clearInput" class="clearInput"></button>
        </li>
      </ul>
      <ul class="statusBox clearfix">
        <li @click="btn1" :class="{on: btnStatus[0]}">产品：{{orderCount}}</li>
        <li @click="btn2" :class="{on: btnStatus[1]}">应扫：{{scanCount}}</li>
        <li @click="btn3" :class="{on: btnStatus[2]}">已扫：{{hadscanCount}}</li>
        <li @click="btn4" :class="{on: btnStatus[3]}">未扫：{{scanCount - hadscanCount}}</li>
      </ul>
    </div>
    <div>
      <TableH></TableH>
      <TableTr id="contain" class="contain" v-bind:style="{height: height+'px'}"></TableTr>
      <div @click="sureIn" v-if="!checkBoxShow && !btnStatus[0]"><Btn class="btn100 sure" :disabled="btnDisabled">{{setinBtnName}}</Btn></div>
      <ul class="delCancel clearfix">
        <li @click="delSN" v-if="checkBoxShow && !btnStatus[0]"><Btn class="btn100 del">删除</Btn></li>
        <li @click="cancel" v-if="checkBoxShow && !btnStatus[0]"><Btn class="btn100 gray cancel">取消</Btn></li>
      </ul>

      <SureBox v-show="sureBoxShow">
        <button @click="no" class="left">取消</button>
        <button @click="ok" class="right">确认</button>
      </SureBox>
      
    </div>
  </div>
</template>
<!-- </keep-alive> -->

<script>
import Vue from 'vue'
import VueRouter from 'vue-router'
import Vuex from 'vuex'
import HeadComponent from '../../components/header'
import TableH from '../../components/table-h'
import TableTr from '../../components/table-tr-sn'
import ScanError from '../../components/purchase/scan-error'
import PutIn from '../../components/purchase/put-in'
import SNDetail from '../../components/purchase/sn-detail'
import Btn from '../../components/btn'
import SureBox from '../../components/sureBox'
import mango, { path, V, setParams, version } from '../../js/variable.js'
// import apiFn from '../../js/lib/api.js'
Vue.use(VueRouter)
Vue.use(Vuex)

export default {
  name: 'snList',
  components: {HeadComponent, TableTr, TableH, ScanError, PutIn, SNDetail, Btn, SureBox},
  data () {
    return {
      height: document.documentElement.clientHeight,
      setinBtnName: '确认入库',
      account: '',
      BUS_NO: this.$route.params.num,
      // BUS_NO: '4500000266',
      focusStatus: true,
      opNum: this.$route.params.num,
      // 按钮对应的数据
      orderCount: 0,
      scanCount: 0,
      hadscanCount: 0,
      // 扫码错误弹框显示/隐藏
      errorShow: false,
      putInShow: false,
      inputVal: '',
      showCheckbox: false,
      btnStatus: [false, true, false, false],
      // 用于判断是否添加sn数组的status属性
      addStatus: true,
      // ifVerify为true，即在应扫按钮亮是才可扫码校验
      ifVerify: true,
      canDel: true,
      moduleName: this.$route.query.moduleName,
      urlParams: this.$route.query.name,
      // 1为可以获取订单列表，2为不可获取且为分包，3为合包，4为不是分包也不是合包
      orderType: null,
      // 用于判断是否第一次push数组
      firstPush: true,
      factory: '',
      factoryNum: '',
      warehouseNum: '',
      ZDDLX: this.$route.query.ZDDLX,
      clearsnArr: true, // 用于销售模块snArr初始化
      salestockupNum: 0,
      errorTime: 0,
      dateVal: '',
      numLength: 0,
      canVerify: true, // 判断输入框是否为人工输入
      mixType: false, // 既是标准包，又有子条码是，为true
      noRepeat: true
    }
  },
  watch: {
    'inputVal': function() {
      if (this.inputVal === '') {
        this.numLength = 0
      }
      // 判断是否人工输入
      if (this.inputVal.length === this.numLength + 1) {
        this.numLength++
        this.canVerify = false
      } else if (this.inputVal.length === this.numLength - 1) {
        this.numLength--
        this.canVerify = false
      } else {
        this.canVerify = true
      }
      if (this.inputVal.indexOf('#') !== -1 || this.inputVal.indexOf('*') !== -1) {
        this.inputVal = this.inputVal.replace(/#/g, '$').replace(/\*/g, '$')
        return
      }
      if (this.ifVerify) {
        this.verify()
      } else {
        alert('请切换到应扫状态！')
      }
    }
  },
  computed: {
    // 在文件table-tr-sn.vue设置
    snCount() {
      return this.$store.state.snCount
    },
    btnDisabled() {
      return this.$store.state.btnDisabled
    },
    sureBoxShow() {
      return this.$store.state.sureBoxShow
    },
    alertMsg() {
      return this.$store.state.alertMsg
    },
    checkBoxShow() {
      return this.$store.state.checkBoxShow
    },
    checkboxVal() {
      return this.$store.state.checkboxVal
    },
    btnNum() {
      return this.status
    },
    snArr() {
      return this.$store.state.snArr
    },
    sns() {
      return this.$store.state.SN
    },
    fbData() {
      return this.$store.state.fbData
    },
    skinCol() {
      return this.$store.state.skinCol
    }
  },
  created: function () {
    // 获取本地缓存
    this.getStorage()
    // 设置注销的回退步数
    localStorage.setItem('routeIndex', '5')
    // getFactorySel(this)
    if (this.urlParams === 'purchase' || this.urlParams === 'salesoutput' || this.urlParams === 'allotinbound') {
      this.orderType = 1
    } else if (this.urlParams === 'salestockup' || this.urlParams === 'salesreturn' || this.urlParams === 'allot') {
      this.orderType = 2
    } else if (this.urlParams === 'product') {
      this.orderType = 3
    }
    // this.getaccount()
    this.snListUrl()
    this.setTableH()
    this.$store.commit('loadingShow', false)
    this.$store.commit('tableH', ['序号', '描述', '条码', '状态'])
    this.focusStatus = true
    // this.$store.commit('changeSkin', localStorage.getItem('skinCol'))
    this.checkBoxShowFn(true) // 再次进入页面是，将sn码选取复选框隐藏
  },
  mounted() {
    console.log(222333, this.dateVal, mango.currentTime())
    let _this = this
    this.$store.commit('isOP', false)
    // 检测，过了12点强制重新登陆。
    let checkTime = setInterval(function() {
      if (_this.checkTime()) {
        clearInterval(checkTime)
        mango.goIndex.call(_this)
      }
    }, 10000)
  },
  methods: {
    setBtnDisabled(x) {
      this.$store.commit('btnDisabled', x)
    },
    setoutinType(x) {
      this.$store.commit('outinType', x)
    },
    setalertMsg(x) {
      this.$store.commit('alertMsg', x)
    },
    setsureBoxShow(x) {
      this.$store.commit('sureBoxShow', x)
    },
    getStorage() {
      this.account = localStorage.getItem('account')
      let temp = mango.storage.getStorage(this.account)
      this.factory = temp['factory']
      this.factoryNum = temp['factoryNum']
      this.warehouse = temp['warehouse']
      this.warehouseNum = temp['warehouseNum']
      this.dateVal = temp['dateVal']
    },
    // getaccount() {
    //   // 获取本地存储账号信息
    //   let accountMsg = localStorage.getItem('accountMsg')
    //   if (accountMsg) {
    //     let obj = eval('(' + accountMsg + ')')
    //     this.account = obj.account
    //   } else {
    //     // console.log('没有本地存储')
    //   }
    // },
    // 点击头部切换按钮
    btn1() {
      this.$store.commit('tableH', ['序号', '物料描述', '数量'])
      this.setIsTr3(true)
      this.btnStatus = [true, false, false, false]
      this.turnArr(this.uniq(this.snArr))
      this.ifVerify = false
      this.canDel = false
    },
    btn2() {
      this.$store.commit('tableH', ['序号', '描述', '条码', '状态'])
      this.setIsTr3(false)
      this.btnStatus = [false, true, false, false]
      this.turnArr(this.snArr)
      this.ifVerify = true
      this.canDel = true
      this.focusStatus = true
    },
    btn3() {
      this.$store.commit('tableH', ['序号', '描述', '条码', '状态'])
      this.setIsTr3(false)
      this.btnStatus = [false, false, true, false]
      this.turnArr(this.snArr)
      this.filtrateArr(true)
      this.ifVerify = false
      this.canDel = false
    },
    btn4() {
      this.$store.commit('tableH', ['序号', '描述', '条码', '状态'])
      this.setIsTr3(false)
      this.btnStatus = [false, false, false, true]
      this.turnArr(this.snArr)
      this.filtrateArr(false)
      this.ifVerify = false
      this.canDel = false
    },
    setIsTr3(x) {
      this.$store.commit('isTr3', x)
    },
    setFbData(arr) {
      this.$store.commit('fbData', arr)
    },
    setSNArr(arr) {
      this.$store.commit('snArr', arr)
    },
    // 设置表头标题
    setTableH() {
      this.$store.commit('tableH', ['序号', '物料', '描述', '数量'])
    },
    // SN列表checkbox复选框显示/隐藏
    checkBoxShowFn(x) {
      if (this.canDel) {
        this.showCheckbox = !x
        this.$store.commit('checkBoxShow', this.showCheckbox)
      }
    },
    loadingShow: function(x) {
      this.$store.commit('loadingShow', x)
    },
    errorBoxHide() {
      this.errorShow = false
    },
    putIn() {
      this.putInShow = false
    },
    clearInput() {
      this.inputVal = ''
    },
    enterKey() {
      if (!this.noRepeat) {
        return
      }
      this.noRepeat = false
      if (this.orderType === 1) {
        this.verify1()
      } else if (this.orderType === 2) {
        this.verify2()
      } else {
        this.verify3()
      }
    },
    // 确认入库
    sureIn() {
      if (this.hadscanCount < this.scanCount) {
        if (this.urlParams === 'product') {
          alert('扫描数量少于应扫数量，不能入库！')
        } else {
          this.setsureBoxShow(true)
        }
      } else {
        this.setSureIn()
        this.$store.commit('checkBoxShow', false)
        this.showCheckbox = false
      }
    },
    cancel() {
      this.$store.commit('checkBoxShow', false)
      this.showCheckbox = false
    },
    ok() {
      this.setsureBoxShow(false)
      this.setSureIn()
      this.$store.commit('checkBoxShow', false)
      this.showCheckbox = false
    },
    no() {
      this.$store.commit('checkBoxShow', false)
      this.showCheckbox = false
      this.setsureBoxShow(false)
    },
    checkTime() {
      let date = new Date()
      // let [hour, minute, second] = [0, 0, 10]
      let [hour, minute, second] = [date.getHours(), date.getMinutes(), date.getSeconds()]
      if (!(hour || minute) && second <= 10) {
        return true
      } else {
        return false
      }
    },
    setSNCopy(arr) {
      this.$store.commit('SNCopy', arr)
    },
    setSN(arr) {
      this.$store.commit('SN', arr)
    },
    snListUrl() {
      let [params, temp] = [{}, this.urlParams]
      if (temp === 'salestockup' || temp === 'salesoutput' || temp === 'salesreturn') {
        params = {
          VBELN: this.opNum,
          WERKS: this.factoryNum,
          LGORT: this.warehouseNum
        }
      } else if (temp === 'purchase') {
        params = {
          BUS_NO: this.BUS_NO,
          ZDDLX: this.ZDDLX,
          WERKS: this.factoryNum,
          LGORT: this.warehouseNum
        }
      } else if (temp === 'product') {
        params = {
          ZRKDH: this.opNum
        }
      } else if (temp === 'allotinbound' || temp === 'allot') {
        params = {
          EBELN: this.opNum,
          WERKS: this.factoryNum,
          LGORT: this.warehouseNum
        }
      }
      let url = path.sap + temp + '/getsn'
      this.getSNList(url, params)
    },
    getSNList(url, params) {
      let _this = this
      _this.loadingShow(true)
      V.get(url, params).then(function(data) {
        _this.loadingShow(false)
        data = JSON.parse(data.responseText)
        _this.turnArrParams(data)
        _this.addStatus = false
      }).catch((res) => {
        alert('请求超时！')
        _this.loadingShow(false)
      })
    },
    turnArrParams(data) {
      let arr = ''
      if (this.urlParams === 'salestockup') {
        this.setoutinType('备货')
        if (data.MT_Salestockup_GetSN_Resp.Header) {
          arr = data.MT_Salestockup_GetSN_Resp.Header
          this.salestockupNum = parseInt(arr[0].LFIMG)
        }
        this.setinBtnName = '确认备货'
      } else if (this.urlParams === 'salesoutput') {
        this.setoutinType('出库')
        if (data.MT_Salesoutput_GetSN_Resp.Header) {
          arr = data.MT_Salesoutput_GetSN_Resp.Header
        }
        this.setinBtnName = '确认出库'
      } else if (this.urlParams === 'purchase') {
        this.setoutinType('入库')
        if (data.MT_Purchase_GetSN_Resp.Header) {
          arr = data.MT_Purchase_GetSN_Resp.Header
          for (let i = 0; i < arr.length; i++) {
            if (!arr[i].ZTIAOM) {
              this.orderType = 2
            }
          }
        }
      } else if (this.urlParams === 'product') {
        this.setoutinType('入库')
        if (data.MT_Product_GetSN_Resp.Header.Item) {
          arr = data.MT_Product_GetSN_Resp.Header.Item
          for (let i in arr) {
            arr[i].status = false
          }
        }
      } else if (this.urlParams === 'salesreturn') {
        this.setoutinType('入库')
        if (data.MT_SalesReturn_GetSN_Resp.Header) {
          arr = data.MT_SalesReturn_GetSN_Resp.Header
        }
      } else if (this.urlParams === 'allotinbound') {
        this.setoutinType('入库')
        if (data.MT_AllotInbound_GetSN_Resp.Header) {
          arr = data.MT_AllotInbound_GetSN_Resp.Header
        }
      } else if (this.urlParams === 'allot') {
        this.setoutinType('出库')
        if (data.MT_Allot_GetSN_Resp.Header) {
          arr = data.MT_Allot_GetSN_Resp.Header
        }
        this.setinBtnName = '确认出库'
      }
      // 讲sn码列表数组保存到store
      // 采购入库模块
      if (this.orderType === 1) {
        this.setSNArr(arr)
      } else if (this.orderType === 2) {
        // 销售备货
        this.setSNArr(arr)
        this.setFbData(arr[0])
      } else if (this.orderType === 3) {
        this.setSNArr(arr)
      }
      // if (this.orderType === 2) {
      //   this.turnArr([])
      // } else {
        // 用于计算产品数量
        this.uniq(arr)
        this.turnArr(arr)
      // }
    },
    afterDelSN(_this, data) {
      _this.putInShow = false
      if (data.MT_DeleteSN_Resp.Item) {
        data = data.MT_DeleteSN_Resp.Item
      }
      if (data.ZXXLX === 'S') {
        alert('删除成功！')
        _this.snListUrl()
      } else {
        alert(data.ZTXXX)
      }
    },
    // 检测条码的是否校验
    checkStatus(ZJYZT, urlParams) {
      let status = false
      if (urlParams === 'purchase') {
        if (ZJYZT === 1 || ZJYZT === 9 || ZJYZT === 'Z') {
          status = true
        } else {
          status = false
        }
      } else if (urlParams === 'salestockup') {
        if (ZJYZT === 2) {
          status = true
        } else {
          status = false
        }
      } else if (urlParams === 'salesoutput') {
        if (ZJYZT === 3) {
          status = true
        } else {
          status = false
        }
      } else if (urlParams === 'salesreturn') {
        if (ZJYZT === 1) {
          status = true
        } else {
          status = false
        }
      } else if (urlParams === 'allot') {
        if (ZJYZT === 8) {
          status = true
        } else {
          status = false
        }
      } else if (urlParams === 'allotinbound') {
        if (ZJYZT === 1) {
          status = true
        } else {
          status = false
        }
      }
      return status
    },
    // 根据对象数组的某个属性进行数组去重
    uniq(arr) {
      let temp = []
      let tempIndex = []
      let itemNo = []
      let snArr = []
      // 提取属性数组
      for (let i in arr) {
        itemNo.push(arr[i].ITEM_NO)
      }
      // 对属性数组去重
      for (let i in itemNo) {
        if (temp.indexOf(itemNo[i]) === -1) {
          temp.push(itemNo[i])
          tempIndex.push(i)
        }
      }
      // 根据去重的属性数组对对象数组去重
      for (let i in tempIndex) {
        snArr.push(arr[tempIndex[i]])
      }
      this.orderCount = temp.length
      return snArr
    },
    verifyStatus() {
      let temp = 0
      if (this.urlParams === 'purchase' || this.urlParams === 'allotinbound') {
        temp = 1
      } else if (this.urlParams === 'salestockup') {
        temp = 2
      } else if (this.urlParams === 'salesoutput') {
        temp = 3
      } else if (this.urlParams === 'salesreturn') {

      }
      return temp
    },
    // 转化成组件table-tr-sn.vue的通用数组数据
    turnArr(arr, elementIndex) {
      // trArr为临时数组   num用于计算应扫数量
      let [trArr, checkboxVal, num, num3] = [[], [], 0, 0]
      if (arr.length >= 0) {
        for (let i in arr) {
          // 页面初次加载时执行
          if (this.addStatus) {
            arr[i].status = false
          }
          let temp = {}
          // 标准包
          // if (arr[i].Item === null || arr[i].Item === undefined) {
          if (!arr[i].Item) {
            // 模块调拨出库跟销售备货的应扫数量接口直接返回
            if (this.urlParams === 'allot') {
              num = parseInt(arr[0].ZYS)
            } else if (this.urlParams === 'salestockup') {
              num = parseInt(arr[0].ZYC)
            } else {
              num++
            }
            // temp.status = false
            checkboxVal.push(false)
            temp.arr = []
            temp.arr[0] = arr[i].MATKL // 物料描述
            if (this.urlParams === 'product') {
              // 如果ZTIAOM长度大于ZDEZTMA为合包，否则为分包
              if (arr[i].ZTIAOM.length > arr[i].ZDEZTMA.length) {
                temp.arr[1] = arr[i].ZTIAOM // SN条码
              } else {
                temp.arr[1] = arr[i].ZDEZTMA // SN条码
              }
              temp.arr[5] = arr[i].status
            } else {
              temp.arr[1] = arr[i].ZTIAOM // SN条码
              if (this.checkStatus(arr[i].ZJYZT, this.urlParams)) {
              temp.arr[5] = true
              } else {
                temp.arr[5] = arr[i].status // 是否校验状态码
              }
            }
            // 计算已扫描数量
            if (temp.arr[5]) {
              num3++
            }
            temp.arr[2] = arr[i].LGOBE // 库存地点描述
            temp.arr[3] = arr[i].BUS_NO // 采购订单号/内向交货单
            temp.arr[4] = parseInt(arr[i].LFIMG) // 计划交货数
            temp.arr[6] = arr[i].ITEM_NO // 行号
            if (this.urlParams === 'allot') {
              temp.arr[7] = parseInt(arr[i].ZWCSL) // 产品数量
            } else if (this.urlParams === 'salestockup') {
              temp.arr[7] = parseInt(arr[i].LFIMG)
            } else {
              temp.arr[7] = this.snArr.length
            }
          } else {
            let fbtype = false
            // 分包
            if (arr[i].Item[0].ZFBFS === 1) {
              fbtype = true
            }
            checkboxVal.push(false)
            temp.status = true // 标记是否含子条码
            temp.arr = []
            temp.arr[0] = arr[i].MATKL
            let arr1 = []
            let arr2 = []
            for (let j in arr[i].Item) {
              // 模块调拨出库跟销售备货的应扫数量接口直接返回
              if (this.urlParams === 'allot') {
                num = parseInt(arr[0].ZYS)
              } else if (this.urlParams === 'salestockup') {
                num = parseInt(arr[0].ZYC)
              } else {
                num++
              }
              // 页面初次加载时执行
              if (this.addStatus) {
                arr2.push(false)
              }
              arr1.push(arr[i].Item[j].ZTIAOMA_FB)
              if (this.checkStatus(arr[i].Item[j].ZJYZT, this.urlParams)) {
                arr2[j] = true
                if (fbtype) {
                  num3++
                }
              }
            }
            if (fbtype === false && this.checkStatus(arr[i].ZJYZT, this.urlParams)) {
              num3++
            }
            temp.arr[1] = arr1
            temp.arr[2] = arr2
            temp.arr[3] = arr[i].BUS_NO
            temp.arr[4] = parseInt(arr[i].LFIMG)
            temp.arr[5] = arr[i].status // 是否校验状态码
            temp.arr[6] = arr[i].ITEM_NO
            if (this.urlParams === 'allot') {
              temp.arr[7] = parseInt(arr[i].ZWCSL) // 产品数量
            } else if (this.urlParams === 'salestockup') {
              temp.arr[7] = parseInt(arr[i].LFIMG)
            } else {
              temp.arr[7] = this.snArr.length
            }
            // if (this.checkStatus(arr[i].ZJYZT, this.urlParams)) {
            //   temp.arr[5] = true
            //   num3++
            // } else {
              // temp.arr[5] = arr[i].status // 是否校验状态码
            // }
          }
          this.hadscanCount = num3
          trArr.push(temp)
        }
      }
      // // 将校验到的条码提升到第一位
      // if (arguments[1]) {
      //   arrElementUp(trArr, elementIndex)
      // }
      // 标示SN码是否扫描的状态数组
      this.setSN(trArr.slice(0, this.snCount))
      this.setSNCopy(trArr)
      this.scanCount = parseInt(num)
      // if (this.addStatus) {
      //   this.status4 = num
      // }
      this.$store.commit('checkboxVal', checkboxVal)
    },
    // 校验sn码
    verify() {
      let num = this.inputVal
      // if (num.length === 13 || num.length === 23 || num.length === 22 || num.length >= 27) {
      if (num.length >= 8 && this.canVerify) {
        if (this.orderType === 1) {
          this.verify1()
        } else if (this.orderType === 2) {
          this.verify2()
        } else {
          this.verify3()
        }
      }
    },
    verify1() {
      let [num, arr, _this, fbtype, index, subindex] = [this.inputVal, this.snArr, this, 0, 0, 0]
      // 过滤误操作
      for (let i in arr) {
        // 标准包装
        if (arr[i].Item === null || arr[i].Item === undefined) {
          if (arr[i].ZTIAOM) {
            if (num === arr[i].ZTIAOM.toString() || num === arr[i].MATNR.toString()) {
              fbtype = 0
              index = i
            }
          }
        } else {
          // 分包
          if (arr[i].Item[0].ZFBFS === 1) {
            for (let j in arr[i].Item) {
              if (num === arr[i].Item[j].ZTIAOMA_FB.toString()) {
                fbtype = 1
                index = i
                subindex = j
              }
            }
          } else if (arr[i].Item[0].ZFBFS === 0) {
            // 既是标准包又有子条码的订单
            if (num === arr[i].Item[0].ZTIAOMA_FB.toString()) {
              fbtype = 0
              index = i
              subindex = 0
              this.mixType = true
            }
          } else {
            // 合包
            if (num === arr[i].ZTIAOM.toString()) {
              fbtype = 2
              index = i
            }
          }
        }
      }

      this.verifyAjax(this.verifyUrl1(arr, index)).then(function(data) {
        if (_this.urlParams === 'purchase') {
          data = data.MT_Purchase_Verify_Resp.Item
        } else if (_this.urlParams === 'salesoutput') {
          data = data.MT_Salesoutput_Verify_Resp.Item
        } else if (_this.urlParams === 'allotinbound') {
          data = data.MT_AllotInbound_Verify_Resp.Item
        }
        // 校验成功
        if (data.ZXXLX === 'S' || data.ZXXLX === 'W') {
          _this.inputVal = ''
          // 标准包
          if (fbtype === 0) {
            // 如果既是标准包，又有子条码且为销售出库时
            if (_this.mixType) {
              arr[index].Item[subindex].ZJYZT = _this.verifyStatus()
              arr[index].ZJYZT = _this.verifyStatus()
            } else {
              arr[index].ZJYZT = _this.verifyStatus()
            }
            _this.setSNArr(arr)
            _this.turnArr(arr, index)
            // _this.inputVal = ''
            _this.focusStatus = true
            // _this.hadscanCount++
          } else if (fbtype === 1) {
            // 分包
            arr[index].Item[subindex].ZJYZT = _this.verifyStatus()
            _this.setSNArr(arr)
            _this.turnArr(arr, index)
            // _this.inputVal = ''
            _this.focusStatus = true
            // _this.hadscanCount++
          } else {
            // 合包
            arr[index].ZJYZT = _this.verifyStatus()
            // 合包主条码通过，则子条码全部通过
            let subarr = arr[index].Item
            for (let i in subarr) {
              subarr[i].ZJYZT = _this.verifyStatus()
              // _this.hadscanCount++
            }
            // _this.setSNArr(arr)
            _this.turnArr(arr, index)
            // _this.inputVal = ''
            _this.focusStatus = true
          }
          // 如果返回W，则弹2秒的提示框
          if (data.ZXXLX === 'W') {
            _this.$store.commit('errorMsg', data.ZTXXX)
            _this.errorShow = true
            setTimeout(() => {
              _this.errorShow = false
            }, 1500)
          }
        } else {
          _this.inputVal = ''
          _this.errorShow = true
          _this.inputVal = ''
          if (_this.urlParams !== 'salestockup') {
            setTimeout(function timer() {
              _this.$store.commit('errorMsg', data.ZTXXX)
            }, 1000)
          }
          // setTimeout(_this.errorShow = false, 1000)
          // _this.inputVal = ''
          // alert(data.ZTXXX)
        }
      })
    },
    verify2() {
      let _this = this
      // if (this.snArr.length < this.salestockupNum) {
        // if (this.snArr.length < this.scanCount) {
        this.verifyAjax(this.verifyUrl2()).then(function(data) {
          if (_this.urlParams === 'salestockup') {
            if (data.MT_Salestockup_Verify_Resp.Item) {
              data = data.MT_Salestockup_Verify_Resp.Item
            } else {
              alert('条码有误！')
            }
          } else if (_this.urlParams === 'salesreturn') {
            if (data.MT_SalesReturn_Verify_Resp.Item) {
              data = data.MT_SalesReturn_Verify_Resp.Item
            } else {
              alert('条码有误！')
            }
          } else if (_this.urlParams === 'allot') {
            if (data.MT_Allot_Verify_Resp.Item) {
              data = data.MT_Allot_Verify_Resp.Item
            } else {
              alert('条码有误！')
            }
          } else if (_this.urlParams === 'purchase') {
            if (data.MT_Purchase_Verify_Resp.Item) {
              data = data.MT_Purchase_Verify_Resp.Item
            } else {
              alert('条码有误！')
            }
          }
          if (data.ZXXLX === 'S' || data.ZXXLX === 'W') {
            _this.inputVal = ''
            _this.snListUrl()
            // 如果返回W，则弹2秒的提示框
            if (data.ZXXLX === 'W') {
              _this.$store.commit('errorMsg', data.ZTXXX)
              _this.errorShow = true
              setTimeout(() => {
                _this.errorShow = false
              }, 1000)
            }
          } else {
            _this.errorShow = true
            _this.$store.commit('errorMsg', data.ZTXXX)
            _this.inputVal = ''
            setTimeout(function timer() {
              _this.errorShow = false
            }, 1500)
          }
        })
      // } else {
      //   alert('条码已扫完！')
      // }
    },
    verify3() {
      let temp = this.snArr
      // 用于条码不存在是，提示信息
      let alertMsg = false
      for (let i in temp) {
        if (temp[i].ZDEZTMA.toString() === '') {
          if (temp[i].ZTIAOM.toString() === this.inputVal) {
            alertMsg = true
            temp[i].status = true
            this.inputVal = ''
          }
        } else {
          if (temp[i].ZDEZTMA.toString() === this.inputVal) {
            alertMsg = true
            temp[i].status = true
            this.inputVal = ''
          }
        }
      }
      if (alertMsg) {
        this.setSNArr(temp)
        this.turnArr(temp)
      } else {
        alert('条码在入库单' + this.opNum + '不存在！')
        this.inputVal = ''
      }
    },
    // verifyUrl1为采购入库校验参数
    verifyUrl1 (arr, i) {
      let params = {}
      params.url = path.sap + this.urlParams + '/verify'
      if (this.urlParams === 'purchase') {
        params.data = {
          BUS_NO: arr[i].BUS_NO,
          ITEM_NO: arr[i].ITEM_NO,
          ZDDLX: this.ZDDLX,
          ZTIAOM: this.inputVal,
          WERKS: this.factoryNum,
          LGORT: this.warehouseNum,
          ZQRKZ: 0,
          ZDEL: 0
        }
      } else if (this.urlParams === 'salesoutput') {
        // let temp = this.snArr[0]
        params.data = {
          VBELN: arr[i].BUS_NO,
          ZTIAOM: this.inputVal,
          ZQRKZ: 0,
          ZDEL: 0,
          WERKS: arr[i].WERKS,
          LGORT: this.warehouseNum,
          ITEM_NO: arr[i].ITEM_NO
        }
      } else if (this.urlParams === 'allotinbound') {
        // let temp = this.snArr[0]
        params.data = {
          EBELN: arr[i].BUS_NO,
          ZTIAOM: this.inputVal,
          ZQRKZ: 0,
          ZDEL: 0,
          WERKS: this.factoryNum,
          LGORT: this.warehouseNum,
          EBELP: arr[i].ITEM_NO
        }
      }
      return params
    },
    // 销售备货校验参数
    verifyUrl2 () {
      let [params, temp] = [{}, this.fbData]
      if (this.urlParams === 'salestockup' || this.urlParams === 'salesreturn') {
        params.url = path.sap + this.urlParams + '/verify'
        params.data = {
          VBELN: temp.BUS_NO,
          ZTIAOM: this.inputVal,
          ZQRKZ: 0,
          ZDEL: 0,
          WERKS: temp.WERKS,
          LGORT: this.warehouseNum
          // ITEM_NO: temp.ITEM_NO
        }
      } else if (this.urlParams === 'allot') {
        params.url = path.sap + this.urlParams + '/verify'
        params.data = {
          EBELN: this.BUS_NO,
          ZTIAOM: this.inputVal,
          ZQRKZ: 0,
          ZDEL: 0,
          WERKS: this.factoryNum,
          LGORT: this.warehouseNum
          // EBELP: temp.ITEM_NO
        }
      } else if (this.urlParams === 'purchase') {
        params.url = path.sap + this.urlParams + '/verify'
        params.data = {
          BUS_NO: temp.BUS_NO,
          ITEM_NO: '',
          ZDDLX: this.ZDDLX,
          ZTIAOM: this.inputVal,
          WERKS: this.factoryNum,
          LGORT: this.warehouseNum,
          ZQRKZ: 0,
          ZDEL: 0
        }
      }
      return params
    },
    verifyAjax(params) {
      let _this = this
      let data = new Promise(function(resolve, reject) {
        _this.loadingShow(true)
        // 提交校验AJAX
        V.get(params.url, params.data).then(function(data) {
          _this.noRepeat = true
          _this.loadingShow(false)
          data = JSON.parse(data.responseText)
          resolve(data)
        }).catch((res) => {
          alert('请求超时！')
          _this.loadingShow(false)
        })
      })
      return data
    },
    // ifScan参数为true则筛选已扫，为false则筛选未扫
    filtrateArr(ifScan) {
      let Arr = this.sns.concat()
      function delArr(arr) {
        let gettype = Object.prototype.toString
        for (let i in arr) {
          // 标准包
          if (gettype.call(arr[i].arr[1]) === '[object String]' || arr[i].arr[1] === undefined) {
            if (ifScan) {
              if (Arr[i].arr[5] === false || arr[i].arr[1] === undefined) {
                arr.splice(i, 1)
                delArr(arr)
              }
            } else {
              if (Arr[i].arr[5] === true || arr[i].arr[1] === undefined) {
                arr.splice(i, 1)
                delArr(arr)
              }
            }
          } else {
            // 分包
            for (let j in arr[i].arr[1]) {
              if (ifScan) {
                if (!arr[i].arr[2][j]) {
                  arr[i].arr[1].splice(j, 1)
                  arr[i].arr[2].splice(j, 1)
                  delArr(arr)
                }
              } else {
                if (arr[i].arr[2][j]) {
                  arr[i].arr[1].splice(j, 1)
                  arr[i].arr[2].splice(j, 1)
                  delArr(arr)
                }
              }
            }
          }
        }
        return arr
      }
      // 将分包的空数组去除
      function reDelArr(arr) {
        for (let i in arr) {
          if (arr[i].arr[1] !== undefined && arr[i].arr[1].length === 0) {
            arr.splice(i, 1)
            reDelArr(arr)
          }
        }
        return arr
      }
      this.setSN(reDelArr(delArr(Arr)).slice(0, this.snCount))
      this.setSNCopy(reDelArr(delArr(Arr)))
    },
    // 检测此分包是否有分包sn码被扫描
    checkSN(Arr, str, ifScan) {
      let temp = false
      let gettype = Object.prototype.toString
      // 第一次调用函数，Arr为空数组
      if (Arr.length > 0) {
        for (let i in Arr) {
          // 该元素是否为数组
          if (gettype.call(Arr[i].arr[1]) !== '[object String]') {
            // 筛选已扫的
            if (ifScan) {
              if (Arr[i].arr[1].indexOf(str) === -1) {
                temp = true
              }
            // 筛选未扫的
            } else {
              if (Arr[i].arr[1].indexOf(str) === -1) {
                temp = true
              }
            }
          }
        }
      } else {
        temp = true
      }
      return temp
    },
    // 确认入库123
    setSureIn() {
      // 为true时按钮不可点击
      this.setBtnDisabled(true)
      let [_this, params, url, ZIP1] = [this, '', '', '']
      if (localStorage.getItem('departmentVal')) {
      ZIP1 = localStorage.getItem('departmentVal').substr(0, 3) + '_' + localStorage.getItem('lineVal1') + '_' + localStorage.getItem('printVal1')
      }
      if (this.urlParams === 'salesreturn') {
        params = '{ "item": {VBELN: ' + this.BUS_NO + ', ZGH: "' + this.account + '", ZQRKZ: 1, ZIP: ' + ZIP1 + ', ZDATE: "' + this.dateVal + '" } }'
        params = setParams(params)
      } else if (this.urlParams === 'salesoutput') {
        params = '{ "item": {VBELN: ' + this.BUS_NO + ', ZGH: "' + this.account + '/' + localStorage.getItem('fullName') + '", ZQRKZ: 1, ZIP: ' + ZIP1 + ', ZDATE: "' + mango.currentTime() + '" } }'
        params = setParams(params)
      } else if (this.urlParams === 'salestockup') {
        params = '{ "item": {VBELN: ' + this.BUS_NO + ', ZGH: "' + this.account + '", ZQRKZ: 1, ZIP: ' + ZIP1 + ', ZDATE: "' + mango.currentTime() + '" } }'
        params = setParams(params)
      } else if (this.urlParams === 'purchase') {
        params = '{ "Item": {BUS_NO: ' + this.BUS_NO + ',LGORT: "' + this.warehouseNum + '"' + ', ZQRKZ: 1, ZDDLX: "' + this.ZDDLX + '", ZGH: "' + this.account + '", ZDATE: "' + this.dateVal + '"} }'
        params = setParams(params)
      } else if (this.urlParams === 'product') {
        let myDate = new Date()
        let dateArr = this.dateVal.split('-')
        if (dateArr[2].length === 1) {
          dateArr[2] = '0' + dateArr[2]
        }
        // function turnDate(num) {
        //   if (num < 10) {
        //     num = '0' + parseInt(num)
        //   }
        //   return num
        // }
        params = {
          ZRKDH: this.BUS_NO,
          ZGZRY: '' + this.account + '',
          // ZGZRQ: '' + myDate.getFullYear() + turnDate(myDate.getMonth() + 1) + turnDate(myDate.getDate()),
          ZGZRQ: dateArr[0] + mango.turnDate(dateArr[1]) + mango.turnDate(dateArr[2]),
          ZGZSJ: '' + mango.turnDate(myDate.getHours()) + mango.turnDate(myDate.getMinutes()) + mango.turnDate(myDate.getSeconds()),
          LGORT: this.warehouseNum
        }
      } else if (this.urlParams === 'allot') {
        params = '{ "Item": {EBELN: ' + this.BUS_NO + ', ZQRKZ: 1, ZGH: "' + this.account + '", WERKS: "' + this.factoryNum + '", LGORT: "' + this.warehouseNum + '", ZDATE: "' + this.dateVal + '"} }'
        params = setParams(params)
      } else if (this.urlParams === 'allotinbound') {
        params = '{ "Item": {EBELN: ' + this.BUS_NO + ', ZQRKZ: 1, ZGH: "' + this.account + '", WERKS: "' + this.factoryNum + '", LGORT: "' + this.warehouseNum + '", ZDATE: "' + this.dateVal + '"} }'
        params = setParams(params)
      }
      if (this.urlParams === 'product') {
        url = path.sap + this.urlParams + '/orderpost'
      } else {
        url = path.sap + this.urlParams + '/confirm'
      }
      this.putInShow = true
      if (this.urlParams === 'product') {
        let _this = this
        // if (this.status4 === 0) {
          V.get(url, params).then(function(data) {
            _this.setBtnDisabled(false)
            data = JSON.parse(data.responseText)
            if (data.MT_Product_OrderPost_Resp.Item) {
              data = data.MT_Product_OrderPost_Resp.Item
              if (data.ZXXLX === 'S') {
                alert(data.ZTXXX)
                _this.$router.back()
              } else {
                alert(data.ZTXXX)
              }
            } else {
              alert('数据缺失！')
            }
            _this.putInShow = false
            // data = JSON.parse(data.responseText)
          })
        // } else {
        //   alert('条码未扫完，不可提交数据！')
        //   _this.putInShow = false
        // }
      } else {
        _this.setalertMsg('正在' + this.$store.state.outinType + '...')
        _this.putInShow = true
        if (version === 'web') {
          V.post(url, params).then(function(data) {
            _this.setBtnDisabled(false)
            _this.putInShow = false
            tip(data)
          }).catch((res) => {
            alert('请求超时！')
            _this.loadingShow(false)
          })
        } else {
          window.apiready(url, params).then(function(data) {
            _this.setBtnDisabled(false)
            if (data) {
              tip(data)
              _this.putInShow = false
            } else {
              alert('请求超时！')
              _this.putInShow = false
            }
          })
        }
        function tip(data) {
          if (_this.urlParams === 'purchase') {
            if (data.MT_Purchase_Confirm_Resp.Item) {
              data = data.MT_Purchase_Confirm_Resp.Item
            }
          } else if (_this.urlParams === 'salestockup') {
            if (data.MT_Salestockup_Confirm_Resp.Item) {
              data = data.MT_Salestockup_Confirm_Resp.Item
            }
          } else if (_this.urlParams === 'salesoutput') {
            if (data.MT_Salesoutput_Confirm_Resp.Item) {
              data = data.MT_Salesoutput_Confirm_Resp.Item
            }
          } else if (_this.urlParams === 'salesreturn') {
            if (data.MT_SalesReturn_Confirm_Resp.Item) {
              data = data.MT_SalesReturn_Confirm_Resp.Item
            }
          } else if (_this.urlParams === 'allot') {
            if (data.MT_Allot_Confirm_Resp.Item) {
              data = data.MT_Allot_Confirm_Resp.Item
            }
          } else if (_this.urlParams === 'allotinbound') {
            if (data.MT_AllotInbound_Confirm_Resp.Item) {
              data = data.MT_AllotInbound_Confirm_Resp.Item
            }
          }
          if (data.ZXXLX === 'S') {
            alert(data.ZTXXX)
            _this.$router.back()
          } else if (data.ZTXXX === 'S') {
            alert(data.ZTXXX)
          } else {
            alert(data.ZTXXX)
          }
        }
      }
    },
    delSN() {
      let [_this, url, paramsArr] = [this, path.sap + 'delete/sn', []]
      for (let i in this.checkboxVal) {
        if (this.checkboxVal[i]) {
          paramsArr.push({
            BUS_NO: this.BUS_NO,
            ZTIAOM: this.snArr[i].ZTIAOM,
            ZDEL: 1,
            WERKS: this.factoryNum
          })
        }
      }
      let params = JSON.stringify({
        Item: paramsArr
      })
      params = setParams(params)
      this.setalertMsg('正在删除...')
      _this.putInShow = true
      if (version === 'web') {
        V.post(url, params).then(function(data) {
          _this.afterDelSN(_this, data)
        }).catch((res) => {
          alert('请求超时！')
          _this.loadingShow(false)
        })
      } else {
        window.apiready(url, params).then(function(data) {
          if (data) {
            _this.afterDelSN(_this, data)
          } else {
            alert('请求超时！')
            _this.putInShow = false
          }
        })
      }
      this.$store.commit('checkBoxShow', false)
      this.showCheckbox = false
    }
  },
  directives: {
    focus: {
      inserted: function (el, {value}) {
        if (value) {
          el.focus()
        }
      }
    }
  }
}
</script>

<!- Add "scoped" attribute to limit CSS to this component only -->
<style scoped lang="scss">
@import "../../assets/sass/variable.scss";
.snList{
  div.table{
    width: 10rem;
    overflow: scroll;
    table{
      border-collapse: collapse;
      border: none;
      outline: none;
      background: none;
    }
    tr{
      border-bottom: 1px solid #ccc;
    }
    th,td{
      border: none;
      border-right: 1px solid #ccc;
      border-bottom: 1px solid #ccc;
      background: none;
    }
  }
  .delBtn{
    position: absolute;
    top: 0.46875rem;
    right: $f40;
    width: $f20;
    height: $f20;
    background: url(../../assets/img/purchase/2_dustbin.png) no-repeat;
    background-size: 100% 100%;
  }
  .sure{
    bottom: $f20;
  }
  ul.delCancel{
    position: absolute;
    bottom: $f20;
    li{
      position: relative;
      float: left;
      width: 5rem;
      height: $f40;
    }
  }
  .statusBox{
    width: 9.6875rem;
    height: $f50;
    margin: 0 auto;
    background: #fff;
    border-top-left-radius: $f4;
    border-top-right-radius: $f4;
    padding-left: $f10;
    box-sizing: border-box;
    li{
      float: left;
      width: 2.03125rem;
      height: $f30;
      margin: $f10 $f10 0 0 ;
      text-align: center;
      color: #fff;
      font-size: $f10;
      line-height: $f30;
      border-radius: $f4;
      background: #b8b8b8;
      overflow-y: hidden;
    }
  }
  .snBox{
    position: relative;
    height: $f30;
    padding: 0 $f15;
    box-sizing: border-box;
    li{
      width: 3.75rem;
      float: left;
      color: #fff;
      font-size: $f18;
    }
    li:nth-child(1){
      width: 5rem;
      margin-right: $f10;
    }
    .clearInput{
      position: absolute;
      top: $f4;
      right: $f15;
      width: $f12;
      height: $f12;
      background: url(../../assets/img/purchase/6_delect.png) no-repeat;
      background-size: $f12 $f12;
    }
    input[disabled="disabled"]{
      width: 4.6rem;
      padding-right: 0;
      color: #fff;
      border-bottom: none;
    }
    input{
      position: relative;
      border-bottom: 1px solid #fff;
      display: block;
      width: 100%;
      padding: $f5 $f15 0 0;
      box-sizing: border-box;
      line-height: $f20;
      color: #fff;
      font-size: $f16;
    }
    input::-webkit-input-placeholder{
      color: #66ffff;
      font-size: $f16;
    } input:-moz-placeholder{
      color: #66ffff;
      font-size: $f16;
    } input::-moz-placeholder{
      color: #66ffff;
      font-size: $f16;
    } input:-ms-input-placeholder{
      color: #66ffff;
      font-size: $f16;
    }
  }
  .contain{
    width: 100%;
    position: absolute;
    top: 0;
    left: 0;
    padding-top: 4.68rem;
    box-sizing: border-box;
    overflow: scroll;
    z-index: -1;
    padding-bottom: 2.1875rem;
  }
}
@each $skin, $col, $subCol, $strongCol, $btnBgCol, $btnBgSubCol in $skin-data {
  .#{$skin} {
    .snList{
      .headBox{
        background: $col;
      }
      .statusBox{
        li.on:nth-child(1){
          background: $btnBgCol;
        }
        li.on:nth-child(2){
          background: #ff9600;
        }
        li.on:nth-child(3){
          background: #38ce54;
        }
        li.on:nth-child(4){
          background: #666;
        }
      }
      .snBox{
        background: $col;
      }
    }
  }
}
</style>
